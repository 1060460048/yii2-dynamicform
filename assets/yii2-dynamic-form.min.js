/**
 * yii2-dynamic-form
 *
 * A jQuery plugin to clone form elements in a nested manner, maintaining accessibility.
 *
 * @author Wanderson Bragan√ßa <wanderson.wbc@gmail.com>
 */
!function($){$.fn.yiiDynamicForm=function(e){return methods[e]?methods[e].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof e&&e?($.error("Method "+e+" does not exist on jQuery.yiiDynamicForm"),!1):methods.init.apply(this,arguments)};var events={beforeClone:"beforeClone",afterClone:"afterClone",limitReached:"limitReached",afterRemove:"afterRemove"},defaults={limit:999,min:1,dynamicItems:".dynamic-items",dynamicItem:".dynamic-item",cloneButton:".clone",deleteButton:".delete",clonePosition:"after",template:!1},config,regex=/(.*-)(\d)(-.*)/i,methods={init:function(e){return this.each(function(){var i=$(this);i.data("yiiDynamicForm")||(config=$.extend({},defaults,e||{}),i.find(config.cloneButton).length&&i.on("click",config.cloneButton,function(e){e.preventDefault(),i.triggerHandler(events.beforeClone,[$(this)]),startClone(e,$(this),i)}),i.on("click",config.deleteButton,function(e){e.preventDefault(),removeItem(i,$(this))}))})},updateContainer:function(){var e=$(this);redoIDs(e),restoreSpecialJs(e),fixFormValidaton()}},startClone=function(e,i,t){var n=t.find(config.dynamicItem).length;n<config.limit?($toclone=$($(config.template).html()),$newclone=$toclone.clone(!1,!1),$newclone.find("input, textarea, select").each(function(){$(this).val("")}),"after"!=config.clonePosition?$(config.dynamicItems).prepend($newclone):$(config.dynamicItems).append($newclone),redoIDs(t),removeErrorCssClass($newclone),restoreSpecialJs(t),fixFormValidaton(),t.triggerHandler(events.afterClone,$newclone)):t.triggerHandler(events.limitReached,config.limit)},fixFormValidaton=function(){$(config.dynamicItem).each(function(e){config.fields.forEach(function(i){var t=i.id.replace("{}",e),n=$("#"+config.formId).yiiActiveForm("find",i.id.replace("{}",0));void 0!==n&&(n=$.extend(!0,{},n),n.id=t,n.container=".field-"+t,n.input="#"+t,n.name=i.name.replace("{}",e),n.value=$("#"+t).val(),n.status=0,"undefined"!==$("#"+config.formId).yiiActiveForm("find",t)&&$("#"+config.formId).yiiActiveForm("remove",t),$("#"+config.formId).yiiActiveForm("add",n))})})},removeItem=function(e,i){var t=e.find(config.dynamicItem).length;t>config.min&&($todelete=i.closest(config.dynamicItem),$todelete.remove(),redoIDs(e),restoreSpecialJs(e),fixFormValidaton(),e.triggerHandler(events.afterRemove))},removeErrorCssClass=function(e){e.find(".has-success").each(function(){$(this).removeClass("has-success")}),e.find(".has-error").each(function(){$(this).removeClass("has-error")})},restoreSpecialJs=function($container){var $hasDatepicker=$(config.dynamicItems).find("[data-plugin-name=datepicker]");$hasDatepicker.length>0&&$hasDatepicker.each(function(){$(this).parent().removeData().datepicker("remove"),$(this).parent().datepicker($(this).attr("data-plugin-options"))});var $hasMaskmoney=$(config.dynamicItems).find("[data-plugin-name=maskMoney]");$hasMaskmoney.length>0&&$hasMaskmoney.each(function(){$(this).parent().find("input").removeData().off();var id="#"+$(this).attr("id"),displayID=id+"-disp";$(displayID).maskMoney("destroy"),$(displayID).maskMoney(eval($(this).attr("data-plugin-options"))),$(displayID).maskMoney("mask",parseFloat($(displayID).val())),$(displayID).on("change",function(){var e=$(displayID).maskMoney("unmasked")[0];$(id).val(e),$(id).trigger("change")})});var $hasFileinput=$(config.dynamicItems).find("[data-plugin-name=fileinput]");$hasFileinput.length>0&&$hasFileinput.each(function(){$(this).fileinput(eval($(this).attr("data-plugin-options")))});var $hasTouchSpin=$(config.dynamicItems).find("[data-plugin-name=TouchSpin]");$hasTouchSpin.length>0&&$hasTouchSpin.each(function(){$(this).TouchSpin("destroy"),$(this).TouchSpin(eval($(this).attr("data-plugin-options")))})},redoIDs=function(e){e.find(config.dynamicItem).each(function(e){var i=e,t=$(this);$(this).find("*").each(function(){var n=$(this).attr("id");if(n){var a=n,o=n.match(regex);o&&4===o.length?(a=o[1]+e+o[3],$(this).attr("id",a)):(a=n+e,$(this).attr("id",a)),n!==a&&t.find(".field-"+n).each(function(){$(this).removeClass("field-"+n).addClass("field-"+a)})}var r=$(this).attr("for");if(r){var o=r.match(regex);o&&4===o.length?$(this).attr("for",o[1]+e+o[3]):$(this).attr("for",r+e)}var c=$(this).attr("name");if(c){var s=c.match(/\[([^}]+)\]/);if(s&&s.length>=1){var l=c;c=[].map.call(l,function(e,t){return isNaN(+e)||"["!==l[t-1]||"]"!==l[t+1]?e:i}).join(""),$(this).attr("name",c)}}})})}}(window.jQuery);
