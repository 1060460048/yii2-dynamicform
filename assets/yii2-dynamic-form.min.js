/**
 * yii2-dynamic-form
 *
 * A jQuery plugin to clone form elements in a nested manner, maintaining accessibility.
 *
 * @author Wanderson Bragan√ßa <wanderson.wbc@gmail.com>
 */
!function($){var pluginName="yiiDynamicForm",regexID=/^(.+?)([-\d-]{1,})(.+)$/i,regexName=/(^.+?)([\[\d{1,}\]]{1,})(\[.+\]$)/i;$.fn.yiiDynamicForm=function(e){return methods[e]?methods[e].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof e&&e?($.error("Method "+e+" does not exist on jQuery.yiiDynamicForm"),!1):methods.init.apply(this,arguments)};var events={beforeInsert:"beforeInsert",afterInsert:"afterInsert",beforeDelete:"beforeDelete",afterDelete:"afterDelete",limitReached:"limitReached"},methods={init:function(e){return this.each(function(){var t=($(this),{});void 0!==$("body").data(pluginName)&&(t=$("body").data(pluginName)),void 0===t[e.widgetContainer]&&(t[e.widgetContainer]=e,t=t,e.template=_parseTemplate(e),$("body").data(pluginName,t),$("#"+e.formId).on("click",e.insertButton,function(t){t.preventDefault(),$("."+e.widgetContainer).triggerHandler(events.beforeInsert,[$(this)]),_addItem(e.widgetContainer,t,$(this))}),$("#"+e.formId).on("click",e.deleteButton,function(t){t.preventDefault(),_deleteItem(e.widgetContainer,t,$(this))}))})},updateContainer:function(){var e=$(this).attr("data-dynamicform");_updateAttributes(e),_restoreSpecialJs(e),_fixFormValidaton(e)}},_parseTemplate=function(e){var t=$(e.template);return t.find("div[data-dynamicform]").each(function(){var e=$("body").data(pluginName)[$(this).attr("data-dynamicform")];if($(e.widgetItem).length>1){var t=$(this).find(e.widgetItem).first()[0].outerHTML;$(this).find(e.widgetBody).html(t)}}),t.find("input, textarea, select").each(function(){$(this).val("")}),t.find('input[type="checkbox"]').each(function(){var e=$(this).attr("name"),i=t.find('input[type="hidden"][name="'+e+'"]').first();i&&($(this).val(1),i.val(0))}),t},_getDataWidgetRoot=function(e){var t=$("body").data(pluginName)[e],i=$(t.widgetBody).parents("div[data-dynamicform]").last().attr("data-dynamicform");return $("body").data(pluginName)[i]},_getLevel=function(e){var t=e.parents("div[data-dynamicform]").length;return t=0>t?0:t},_count=function(e,t){var i=$("body").data(pluginName)[t];return e.closest("."+t).find(i.widgetItem).length},_creatIdentifiers=function(e){return new Array(e+2).join("0").split("")},_addItem=function(e,t,i){var a=$("body").data(pluginName)[e],n=_count(i,e);n<a.limit?($toclone=a.template,$newclone=$toclone.clone(!1,!1),"top"===a.insertPosition?i.closest("."+a.widgetContainer).find(a.widgetBody).prepend($newclone):i.closest("."+a.widgetContainer).find(a.widgetBody).append($newclone),_updateAttributes(e),_restoreSpecialJs(e),_fixFormValidaton(e),i.closest("."+e).triggerHandler(events.afterInsert,$newclone)):i.closest("."+e).triggerHandler(events.limitReached,a.limit)},_removeValidations=function(e,t,i){if(i>1){e.find("div[data-dynamicform]").each(function(){for(var e=$("body").data(pluginName)[$(this).attr("data-dynamicform")],t=_getLevel($(this)),i=_creatIdentifiers(t),a=$(this).find(e.widgetItem).length,n=1;a-1>=n;n++){var r=i;r[t]=n,e.fields.forEach(function(t){var i=t.id.replace("{}",r.join("-"));"undefined"!==$("#"+e.formId).yiiActiveForm("find",i)&&$("#"+e.formId).yiiActiveForm("remove",i)})}});var a=_getLevel(e.closest("."+t.widgetContainer)),n=_getDataWidgetRoot(t.widgetContainer),r=_creatIdentifiers(a);r[0]=$(n.widgetItem).length-1,r[a]=i-1,t.fields.forEach(function(e){var i=e.id.replace("{}",r.join("-"));"undefined"!==$("#"+t.formId).yiiActiveForm("find",i)&&$("#"+t.formId).yiiActiveForm("remove",i)})}},_deleteItem=function(e,t,i){var a=$("body").data(pluginName)[e],n=_count(i,e);if(n>a.min){$todelete=i.closest(a.widgetItem);var r=$("."+a.widgetContainer).triggerHandler(events.beforeDelete,$todelete);r!==!1&&(_removeValidations($todelete,a,n),$todelete.remove(),_updateAttributes(e),_restoreSpecialJs(e),_fixFormValidaton(e),$("."+a.widgetContainer).triggerHandler(events.afterDelete))}},_updateAttrID=function(e,t,i,a,n){var r=t.attr("id"),o=r;if(void 0!==r){var d=r.match(regexID);if(d&&4===d.length){d[2]=d[2].substring(1,d[2].length-1);var c=d[2].split("-");c[0]=i,n>0&&void 0!==c[n]&&(c[n]=t.closest(a.widgetItem).index()),o=d[1]+"-"+c.join("-")+"-"+d[3],t.attr("id",o)}else o=r+i,t.attr("id",o)}return r!==o&&(e.find(".field-"+r).each(function(){$(this).removeClass("field-"+r).addClass("field-"+o)}),t.closest(e).find("label[for='"+r+"']").attr("for",o)),o},_updateAttrName=function(e,t,i,a,n){var r=t.attr("name");if(void 0!==r){var o=r.match(regexName);if(o&&4===o.length){o[2]=o[2].replace(/\]\[/g,"-").replace(/\]|\[/g,"");var d=o[2].split("-");d[0]=i,n>0&&void 0!==d[n]&&(d[n]=t.closest(a.widgetItem).index()),r=o[1]+"["+d.join("][")+"]"+o[3],t.attr("name",r)}}return r},_updateAttributes=function(e){var t=_getDataWidgetRoot(e);$(t.widgetItem).each(function(e){var i=$(this),a=0,n=t;$(this).find("*").each(function(){void 0!==$(this).attr("data-dynamicform")&&(n=$("body").data(pluginName)[$(this).attr("data-dynamicform")],a=_getLevel($(this))),_updateAttrID(i,$(this),e,n,a),_updateAttrName(i,$(this),e,n,a)})})},_fixFormValidatonInput=function(e,t,i,a){var n=t.baseConfig;void 0!==n&&(n=$.extend(!0,{},n),n.id=a,n.container=".field-"+a,n.input="#"+a,n.name=t.name.replace("{}",i),n.value=$("#"+a).val(),n.status=0,"undefined"!==$("#"+e.formId).yiiActiveForm("find",a)&&$("#"+e.formId).yiiActiveForm("remove",a),$("#"+e.formId).yiiActiveForm("add",n))},_fixFormValidatonInputs=function(e,t,i,a){e.fields.forEach(function(n){var r=_creatIdentifiers(t),o=$("#"+e.formId).yiiActiveForm("find",n.id.replace("{}",r.join("-")));if(void 0!==o){n.baseConfig=o,r[0]=i,r[t]=a;var d=n.id.replace("{}",r.join("-")),c=n.name.replace("{}",r.join("]["));_fixFormValidatonInput(e,n,a,d,c)}})},_fixFormValidaton=function(e){var t=_getDataWidgetRoot(e);$(t.widgetItem).each(function(e){var i=($(this),0),a=t;_fixFormValidatonInputs(t,i,e,e),$(this).find("div[data-dynamicform]").each(function(){a=$("body").data(pluginName)[$(this).attr("data-dynamicform")],i=_getLevel($(this)),i>0&&$(this).find(a.widgetItem).each(function(t){_fixFormValidatonInputs(a,i,e,t)})})})},_restoreSpecialJs=function(widgetContainer){var rootData=_getDataWidgetRoot(widgetContainer),$hasDatepicker=$(rootData.widgetItem).find("[data-krajee-datepicker]");$hasDatepicker.length>0&&$hasDatepicker.each(function(){$(this).parent().removeData().datepicker("remove"),$(this).parent().datepicker(eval($(this).attr("data-krajee-datepicker")))});var $hasTimepicker=$(rootData.widgetItem).find("[data-krajee-timepicker]");$hasTimepicker.length>0&&$hasTimepicker.each(function(){$(this).removeData().off(),$(this).parent().find(".bootstrap-timepicker-widget").remove(),$(this).unbind(),$(this).timepicker(eval($(this).attr("data-krajee-timepicker")))});var $hasMaskmoney=$(rootData.widgetItem).find("[data-krajee-maskMoney]");$hasMaskmoney.length>0&&$hasMaskmoney.each(function(){$(this).parent().find("input").removeData().off();var id="#"+$(this).attr("id"),displayID=id+"-disp";$(displayID).maskMoney("destroy"),$(displayID).maskMoney(eval($(this).attr("data-krajee-maskMoney"))),$(displayID).maskMoney("mask",parseFloat($(id).val())),$(displayID).on("change",function(){var e=$(displayID).maskMoney("unmasked")[0];$(id).val(e),$(id).trigger("change")})});var $hasFileinput=$(rootData.widgetItem).find("[data-krajee-fileinput]");$hasFileinput.length>0&&$hasFileinput.each(function(){$(this).fileinput(eval($(this).attr("data-krajee-fileinput")))});var $hasTouchSpin=$(rootData.widgetItem).find("[data-krajee-TouchSpin]");$hasTouchSpin.length>0&&$hasTouchSpin.each(function(){$(this).TouchSpin("destroy"),$(this).TouchSpin(eval($(this).attr("data-krajee-TouchSpin")))});var $hasSpectrum=$(rootData.widgetItem).find("[data-krajee-spectrum]");$hasSpectrum.length>0&&$hasSpectrum.each(function(){var id="#"+$(this).attr("id"),sourceID=id+"-source";$(sourceID).spectrum("destroy"),$(sourceID).unbind(),$(id).unbind();var configSpectrum=eval($(this).attr("data-krajee-spectrum"));configSpectrum.change=function(e){jQuery(id).val(e.toString())},$(sourceID).attr("name",$(sourceID).attr("id")),$(sourceID).spectrum(configSpectrum),$(sourceID).spectrum("set",jQuery(id).val()),$(id).on("change",function(){$(sourceID).spectrum("set",jQuery(id).val())})});var $hasDepdrop=$(rootData.widgetItem).find("[data-krajee-depdrop]");$hasDepdrop.length>0&&$hasDepdrop.each(function(){$(this).removeData().off(),$(this).unbind();var configDepdrop=eval($(this).attr("data-krajee-depdrop")),inputID=$(this).attr("id"),matchID=inputID.match(regex);if(matchID&&4===matchID.length)for(index=0;index<configDepdrop.depends.length;++index){var match=configDepdrop.depends[index].match(regex);match&&4===match.length&&(configDepdrop.depends[index]=match[1]+matchID[2]+match[3])}$(this).depdrop(configDepdrop)});var $hasSelect2=$(rootData.widgetItem).find("[data-krajee-select2]");$hasSelect2.length>0&&$hasSelect2.each(function(){var id=$(this).attr("id"),configSelect2=eval($(this).attr("data-krajee-select2"));$(this).select2("destroy"),$.when($("#"+id).select2(configSelect2)).done(initSelect2Loading(id)),$("#"+id).on("select2-open",function(){initSelect2DropStyle(id)}),$(this).attr("data-krajee-depdrop")&&($(this).on("depdrop.beforeChange",function(e,i,v){var configDepdrop=eval($(this).attr("data-krajee-depdrop")),loadingText=configDepdrop.loadingText?configDepdrop.loadingText:"Loading ...";$("#"+id).select2("data",{text:loadingText})}),$(this).on("depdrop.change",function(){$("#"+id).select2("val",$("#"+id).val())}))})}}(window.jQuery);
